<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test: HTML Fragment Loading</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-container {
      background: white;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    .loading-placeholder {
      color: #666;
      font-style: italic;
      padding: 40px;
      text-align: center;
      background: #f9f9f9;
      border-radius: 4px;
    }
    .loaded-fragment {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .loaded-fragment h1 {
      color: #22c55e;
      margin-top: 0;
    }
    .loaded-fragment nav {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    .loaded-fragment nav a {
      margin-right: 15px;
      color: #3b82f6;
      text-decoration: none;
    }
    .loaded-fragment nav a:hover {
      text-decoration: underline;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background: #2563eb;
    }
    .status {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      background: #e0f2fe;
      color: #075985;
    }
  </style>
</head>
<body>
  <h1>üß™ Test: Async HTML Fragment Loading</h1>
  <p>Test del Task 2: caricamento di frammenti HTML con <code>data-html-src</code></p>

  <div class="test-container">
    <h2>Test 1: Caricamento Manuale</h2>
    <button onclick="testManualLoad()">Carica Fragment Manualmente</button>
    <div class="status" id="status1">Clicca il pulsante per caricare</div>
    
    <div id="fragment-manual" data-html-src="./tests/fixtures/test-fragment.html">
      <div class="loading-placeholder">‚è≥ In attesa di caricamento...</div>
    </div>
  </div>

  <div class="test-container">
    <h2>Test 2: Caricamento con Intersection Observer</h2>
    <p>Scrolla verso il basso per vedere il caricamento automatico</p>
    <div class="status" id="status2">Osservato dall'IntersectionObserver</div>
  </div>

  <div style="height: 600px; background: linear-gradient(to bottom, #e0f2fe 0%, #f5f5f5 100%); display: flex; align-items: center; justify-content: center; border-radius: 8px; margin: 20px 0;">
    <p style="color: #666; font-size: 18px;">‚¨áÔ∏è Scrolla gi√π ‚¨áÔ∏è</p>
  </div>

  <div class="test-container">
    <div id="fragment-auto" data-html-src="./tests/fixtures/test-fragment.html">
      <div class="loading-placeholder">‚è≥ Questo si caricher√† automaticamente quando diventa visibile...</div>
    </div>
  </div>

  <script src="./builder/js-components/lazy-app-loader.js"></script>
  <script>
    // Test 1: Caricamento manuale
    async function testManualLoad() {
      const container = document.getElementById('fragment-manual');
      const status = document.getElementById('status1');
      
      try {
        status.textContent = '‚è≥ Caricamento in corso...';
        status.style.background = '#fef3c7';
        status.style.color = '#92400e';
        
        await window.LazyAppLoader.loadHtmlFragment(container);
        
        status.textContent = '‚úÖ Fragment caricato con successo!';
        status.style.background = '#d1fae5';
        status.style.color = '#065f46';
      } catch (error) {
        status.textContent = '‚ùå Errore: ' + error.message;
        status.style.background = '#fee2e2';
        status.style.color = '#991b1b';
      }
    }

    // Test 2: Caricamento automatico con IntersectionObserver
    // Per questo test, dobbiamo integrare data-html-src con l'observer esistente
    // Per ora, aggiungiamo un observer custom
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(async entry => {
        if (entry.isIntersecting) {
          const container = entry.target;
          const status = document.getElementById('status2');
          
          if (container.dataset.htmlLoaded !== 'true') {
            try {
              status.textContent = '‚è≥ Fragment visibile, caricamento in corso...';
              status.style.background = '#fef3c7';
              status.style.color = '#92400e';
              
              await window.LazyAppLoader.loadHtmlFragment(container);
              
              status.textContent = '‚úÖ Fragment caricato automaticamente!';
              status.style.background = '#d1fae5';
              status.style.color = '#065f46';
              
              observer.unobserve(container);
            } catch (error) {
              status.textContent = '‚ùå Errore: ' + error.message;
              status.style.background = '#fee2e2';
              status.style.color = '#991b1b';
            }
          }
        }
      });
    });

    // Osserva il fragment automatico
    const autoFragment = document.getElementById('fragment-auto');
    observer.observe(autoFragment);

    // Log evento custom
    document.addEventListener('html-fragment-loaded', (e) => {
      console.log('‚úÖ html-fragment-loaded event fired!', e.detail);
    });
  </script>
</body>
</html>
