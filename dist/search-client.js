(()=>{const searchInput=document.getElementById("searchInput"),searchResults=document.getElementById("searchResults");if(!searchInput||!searchResults)return;let searchData=null,searchIndex=null,searchDataPromise=null,currentFocus=-1,currentLanguage=null,searchTimeout=null,isDestroyed=!1,abortController=null,lastSearchTime=0;const RATE_LIMIT_MS="undefined"!=typeof CONFIG&&CONFIG.SEARCH?CONFIG.SEARCH.RATE_LIMIT_MS:100,MIN_QUERY_LENGTH="undefined"!=typeof CONFIG&&CONFIG.SEARCH?CONFIG.SEARCH.MIN_QUERY_LENGTH:2,DEBOUNCE_DELAY="undefined"!=typeof CONFIG&&CONFIG.SEARCH?CONFIG.SEARCH.DEBOUNCE_DELAY:300,FETCH_TIMEOUT="undefined"!=typeof CONFIG&&CONFIG.SEARCH?CONFIG.SEARCH.FETCH_TIMEOUT:5e3,MAX_RESULTS="undefined"!=typeof CONFIG&&CONFIG.SEARCH?CONFIG.SEARCH.MAX_RESULTS:10;currentLanguage=(()=>{const pathMatch=window.location.pathname.match(/^\/([a-z]{2})\//);if(pathMatch)return pathMatch[1];const htmlLang=document.documentElement.lang;return htmlLang&&htmlLang.length>=2?htmlLang.substring(0,2):null})();const cleanup=()=>{isDestroyed=!0,searchTimeout&&(clearTimeout(searchTimeout),searchTimeout=null),abortController&&(abortController.abort(),abortController=null),searchData=null,searchIndex=null,searchDataPromise=null};window.addEventListener("pagehide",cleanup),document.addEventListener("visibilitychange",()=>{document.hidden&&cleanup()});const domObserver=new MutationObserver(()=>{document.body.contains(searchInput)&&document.body.contains(searchResults)||(cleanup(),domObserver.disconnect())});domObserver.observe(document.body,{childList:!0,subtree:!0});const loadSearchIndex=async()=>{if(isDestroyed)throw new Error("Search has been destroyed");return searchData||searchDataPromise||(searchDataPromise=(async()=>{try{abortController=new AbortController;const timeoutId=setTimeout(()=>abortController.abort(),FETCH_TIMEOUT),response=await fetch("/search-index.json",{signal:abortController.signal});if(clearTimeout(timeoutId),!response.ok)throw new Error(`HTTP error! status: ${response.status}`);const data=await response.json();if(isDestroyed)throw new Error("Search was destroyed during loading");return searchIndex=data,!currentLanguage&&data.config&&data.config.defaultLanguage&&(currentLanguage=data.config.defaultLanguage),searchData=data.config&&data.config.multilingualAware&&currentLanguage?data.pages.filter(page=>page.language===currentLanguage):data.pages,abortController=null,searchData}catch(_error){if("AbortError"!==_error.name&&console.error("Failed to load search index:",_error),searchDataPromise=null,abortController=null,!isDestroyed&&searchResults&&"AbortError"!==_error.name){const errorMessage="AbortError"===_error.name?t("search_timeout","Search request timeout"):t("search_error","Search unavailable");searchResults.innerHTML=`<div class="search-no-results">${errorMessage}</div>`,searchResults.hidden=!1}throw _error}})(),searchDataPromise)},highlightMatches=(text,query)=>{if(!query||!text)return text;const escapedQuery=query.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");if(escapedQuery.length>200)return console.warn("Query too long for highlighting"),text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");try{const regex=new RegExp(`(${escapedQuery})`,"gi");return text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(regex,'<span class="search-result-match">$1</span>')}catch(_error){return console.error("Error creating regex:",_error),text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}},performSearch=async query=>{if(isDestroyed)return;if(!query||query.length<MIN_QUERY_LENGTH)return searchResults.hidden=!0,searchResults.style.display="none",searchResults.innerHTML="",void searchInput.setAttribute("aria-expanded","false");if(!searchData){searchResults.innerHTML=`<div class="search-loading">${t("search_loading","Loading...")}</div>`,searchResults.hidden=!1,searchInput.setAttribute("aria-expanded","true");try{await loadSearchIndex()}catch{return}if(isDestroyed||searchInput.value.trim()!==query)return}const results=((query,pages)=>{const now=Date.now();if(now-lastSearchTime<RATE_LIMIT_MS)return[];lastSearchTime=now;const lowerQuery=query.toLowerCase(),queryTerms=lowerQuery.split(/\s+/),results=[];for(const page of pages){let score=0;const title=(page.title||"").toLowerCase(),description=(page.description||"").toLowerCase(),content=(page.content||"").toLowerCase(),headings=(page.headings||[]).map(h=>h.toLowerCase()),keywords=(page.keywords||[]).map(k=>k.toLowerCase());keywords.some(keyword=>keyword===lowerQuery)&&(score+=15),title===lowerQuery?score+=20:title.includes(lowerQuery)?score+=10:queryTerms.forEach(term=>{title.includes(term)&&(score+=5)}),description.includes(lowerQuery)?score+=5:queryTerms.forEach(term=>{description.includes(term)&&(score+=2)}),headings.forEach(heading=>{heading.includes(lowerQuery)?score+=3:queryTerms.forEach(term=>{heading.includes(term)&&(score+=1)})}),keywords.forEach(keyword=>{keyword.includes(lowerQuery)?score+=8:queryTerms.forEach(term=>{keyword.includes(term)&&(score+=4)})}),content.includes(lowerQuery)&&(score+=1),score>0&&results.push({...page,score})}return results.sort((a,b)=>b.score-a.score).slice(0,MAX_RESULTS)})(query,searchData);if(isDestroyed||searchInput.value.trim()!==query)return;if(0===results.length)return searchResults.innerHTML=`<div class="search-no-results">${t("search_no_results","No results found")}</div>`,searchResults.hidden=!1,void(searchResults.style.display="block");const html=results.map((page,index)=>{const title=highlightMatches(page.title,query),description=highlightMatches(page.description||`${page.content.substring(0,150)}...`,query);return`\n                <a href="${page.url}" class="search-result-item" data-index="${index}">\n                    <div class="search-result-title">${title}</div>\n                    <div class="search-result-description">${description}</div>\n                </a>\n            `}).join("");searchResults.innerHTML=html,searchResults.hidden=!1,searchResults.style.display="block",searchInput.setAttribute("aria-expanded","true"),currentFocus=-1};let currentSearchId=0;searchInput.addEventListener("input",e=>{searchTimeout&&(clearTimeout(searchTimeout),searchTimeout=null);const query=e.target.value.trim();if(query.length<MIN_QUERY_LENGTH)return currentSearchId++,void performSearch(query);const searchId=++currentSearchId;searchTimeout=setTimeout(()=>{searchTimeout=null,searchId===currentSearchId&&performSearch(query)},DEBOUNCE_DELAY)}),searchInput.addEventListener("focus",()=>{isDestroyed||loadSearchIndex()}),searchInput.addEventListener("blur",()=>{const blurDelay="undefined"!=typeof CONFIG&&CONFIG.UI?CONFIG.UI.BLUR_DELAY:200;setTimeout(()=>{searchResults.hidden=!0,searchResults.style.display="none"},blurDelay)}),searchInput.addEventListener("keydown",e=>{const items=searchResults.querySelectorAll(".search-result-item");"ArrowDown"===e.key?(e.preventDefault(),currentFocus++,currentFocus>=items.length&&(currentFocus=0),setActive(items)):"ArrowUp"===e.key?(e.preventDefault(),currentFocus--,currentFocus<0&&(currentFocus=items.length-1),setActive(items)):"Enter"===e.key?(e.preventDefault(),currentFocus>-1&&items[currentFocus]&&items[currentFocus].click()):"Escape"===e.key&&(searchResults.hidden=!0,searchResults.style.display="none",searchInput.blur())});const setActive=items=>{items.forEach((item,index)=>{const isActive=index===currentFocus;item.classList.toggle("active",isActive),item.setAttribute("aria-selected",isActive)}),items[currentFocus]&&items[currentFocus].scrollIntoView({block:"nearest"})};document.addEventListener("click",e=>{searchInput.contains(e.target)||searchResults.contains(e.target)||(searchResults.hidden=!0,searchResults.style.display="none")})})(),(()=>{const searchToggle=document.getElementById("searchToggle"),searchModal=document.getElementById("searchModal"),searchModalClose=document.getElementById("searchModalClose"),searchModalOverlay=document.getElementById("searchModalOverlay"),searchInput=document.getElementById("searchInput"),searchClearBtn=document.getElementById("searchClearBtn");if(!searchToggle||!searchModal)return;const openModal=()=>{searchModal.setAttribute("aria-hidden","false"),document.body.style.overflow="hidden",setTimeout(()=>{searchInput&&searchInput.focus()},100)},closeModal=()=>{searchModal.setAttribute("aria-hidden","true"),document.body.style.overflow="",searchInput&&(searchInput.value="",searchInput.dispatchEvent(new Event("input")))};searchInput&&searchClearBtn&&(searchInput.addEventListener("input",()=>{searchInput.value.length>0?searchClearBtn.removeAttribute("hidden"):searchClearBtn.setAttribute("hidden","")}),searchClearBtn.addEventListener("click",()=>{searchInput.value="",searchInput.dispatchEvent(new Event("input")),searchInput.focus()})),searchToggle.addEventListener("click",openModal),searchModalClose&&searchModalClose.addEventListener("click",closeModal),searchModalOverlay&&searchModalOverlay.addEventListener("click",closeModal),document.addEventListener("keydown",e=>{"Escape"===e.key&&"false"===searchModal.getAttribute("aria-hidden")&&closeModal()}),document.addEventListener("keydown",e=>{(e.metaKey||e.ctrlKey)&&"k"===e.key&&(e.preventDefault(),openModal())})})();